<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing App</title>
    <style>
        canvas {
            border: 1px solid black;
            background-color: black;
        }
        .drawing-box {
            width: 400px;
            height: 300px;
            overflow: visible; /* Ensure drawing stays within the box */
        }
    </style>
</head>
<body>
    <h1>Drawing App</h1>
    <div class="drawing-box">
        <canvas id="drawingCanvas" width="800" height="600"></canvas>
    </div>
    <br>
    <button onclick="clearCanvas()">Clear</button>
    <button onclick="saveDrawing()">Save</button>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');

        // Define the smaller drawing box dimensions
        const drawingBox = document.querySelector('.drawing-box');
        const boxWidth = drawingBox.offsetWidth;
        const boxHeight = drawingBox.offsetHeight;

        // Resize the canvas to fit the drawing box
        canvas.width = boxWidth;
        canvas.height = boxHeight;

        let isDrawing = false;

        // Event listeners for mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDrawing);
        canvas.addEventListener('mouseleave', endDrawing);

        function startDrawing(e) {
            isDrawing = true;
            draw(e);  // To start drawing immediately at the click position
        }

        function draw(e) {
            if (!isDrawing) return;

            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'white';

            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function endDrawing() {
            isDrawing = false;
            ctx.beginPath();  // Reset path
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveDrawing() {
            // Convert canvas to base64 image data
            const dataURL = canvas.toDataURL('image/png');

            // Create a FormData object to send as form-data
            const formData = new FormData();
            formData.append('file', dataURLToFile(dataURL)); // Convert data URL to Blob/File

            // Send drawing data to Flask backend
            fetch('http://127.0.0.1:5000/process', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                // Update HTML with prediction result
                document.getElementById('predictionResult').innerText = `Predicted digit: ${data.value}`;
            })
            .catch(error => console.error('Error saving drawing:', error));
        }

        // Function to convert Data URL to File/Blob
        function dataURLToFile(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], 'drawing.png', { type: mime });
        }
    </script>
</body>
</html>
